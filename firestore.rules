
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================================================
    // Helper Functions
    // =====================================================================
    function isSignedIn() {
      return request.auth != null;
    }

    // Role-based helpers using Custom Claims (the synced credentials)
    function isAdmin() {
      return request.auth.token.role == 'admin';
    }

    function isProjectManager() {
      return request.auth.token.role == 'project_manager' || isAdmin();
    }
    
    function isViewer() {
      return request.auth.token.role == 'viewer' || isProjectManager();
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Checks if the user doc in DB has the project ID
    function isAssignedToProject(projectId) {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return isSignedIn() && (userDoc.data.assignedProjects.hasAny([projectId]) || isProjectManager());
    }

    // =====================================================================
    // Collection Rules
    // =====================================================================

    match /users/{userId} {
      // Admins/PMs can see everyone. Users can see themselves.
      allow get: if isSignedIn() && (isProjectManager() || isOwner(userId));
      allow list: if isSignedIn() && isProjectManager();
      
      // Only Admins can change roles/status. Users can update their own profile fields.
      allow update: if isSignedIn() && (isAdmin() || (isOwner(userId) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'status'])));
      
      // Admin only creation/deletion via client
      allow create, delete: if isSignedIn() && isAdmin();
    }

    match /projects/{projectId} {
      allow list: if isSignedIn() && isProjectManager();
      allow get: if isSignedIn() && (isProjectManager() || isAssignedToProject(projectId));
      allow write: if isSignedIn() && isProjectManager();
    }

    match /contractors/{contractorId} {
      allow list: if isSignedIn() && isProjectManager();
      allow get: if isSignedIn() && (isProjectManager() || isViewer()); // Restricted by UI logic
      allow write: if isSignedIn() && isProjectManager();
    }

    match /dailyReports/{reportId} {
      allow list: if isSignedIn() && isProjectManager();
      allow get: if isSignedIn() && (isProjectManager() || isAssignedToProject(resource.data.projectId));
      allow write: if isSignedIn() && isProjectManager();
    }

    match /monthlyReports/{reportId} {
      allow list: if isSignedIn() && isProjectManager();
      allow get: if isSignedIn() && (isProjectManager() || isAssignedToProject(resource.data.projectId));
      allow write: if isSignedIn() && isProjectManager();
    }

    match /system/{docId} {
      allow read: if isSignedIn();
      allow write: if false;
    }
  }
}
