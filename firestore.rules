rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * EXCELLERE REVIVE - SEGURIDAD GRANULAR BASADA EN ROLES
     */

    function isSignedIn() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function getRole() {
      return getUserData().role;
    }

    function isAdmin() {
      return isSignedIn() && (
        getRole() == 'admin' ||
        exists(/databases/$(database)/documents/system_roles_admin/$(request.auth.uid))
      );
    }

    function isProjectManager() {
      return isSignedIn() && getRole() == 'project_manager';
    }

    function isViewer() {
      return isSignedIn() && getRole() == 'viewer';
    }

    /** 
     * PERFILES DE USUARIO
     * Admin: CRUD total
     * Usuario: Lectura propia y actualización de campos no críticos
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isAdmin() || (
        isSignedIn() && 
        request.auth.uid == userId && 
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'assignedModules', 'status'])
      );
      allow delete: if isAdmin();
    }

    /** 
     * PROYECTOS, CONTRATISTAS Y REPORTES
     * Admin: CRUD (C, R, U, D)
     * PM: C, R, D (Siguiendo requerimiento específico)
     * Viewer: R
     */
    match /{collection}/{id} {
      allow read: if isSignedIn();
      
      // Permitir creación y eliminación a Admin y PM
      allow create, delete: if isAdmin() || isProjectManager();
      
      // Solo el Admin puede actualizar (Update)
      allow update: if isAdmin();

      // Aplicar esto solo a las colecciones de negocio
      match /projects/{id} { allow read, write: if false; } // Cubierto por el bloque superior
      match /contractors/{id} { allow read, write: if false; }
      match /dailyReports/{id} { allow read, write: if false; }
      match /monthlyReports/{id} { allow read, write: if false; }
    }

    /** CONFIGURACIÓN Y REFERENCIAS (Solo Admin) */
    match /roles/{id} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /modules/{id} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /system_roles_admin/{adminUid} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /system/metadata { allow read: if isSignedIn(); allow write: if isAdmin(); }
  }
}