rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // Explicit role check functions for maximum clarity and reliability
    function isAdmin() {
      return request.auth.token.role == 'admin';
    }

    function isProjectManager() {
      return request.auth.token.role == 'project_manager';
    }

    function isViewer() {
      return request.auth.token.role == 'viewer';
    }

    // /users collection Rules
    match /users/{userId} {
      // CREATE: A new user can create their own document during sign-up. An admin can create any user document.
      allow create: if (isSignedIn() && request.auth.uid == userId) || isAdmin();
      
      // READ (Single Document): A user can read their own profile. Admins can read any profile.
      allow get: if (isSignedIn() && request.auth.uid == userId) || isAdmin();
      
      // READ (List Documents): Only admins can list all users.
      allow list: if isAdmin();
      
      // UPDATE: A user can update their own document (but not their role). An admin can update any field.
      allow update: if (isSignedIn() && request.auth.uid == userId && request.resource.data.role == resource.data.role) || isAdmin();
      
      // DELETE: Only admins can delete users.
      allow delete: if isAdmin();
    }

    // /projects collection Rules
    match /projects/{projectId} {
      // READ: Any user with a valid role can read project data.
      allow get, list: if isAdmin() || isProjectManager() || isViewer();
      
      // WRITE: Only Admins and Project Managers can create, update, or delete projects.
      allow write: if isAdmin() || isProjectManager();
    }

    // /contractors collection Rules
    match /contractors/{contractorId} {
      // READ: Any user with a valid role can read contractor data.
      allow get, list: if isAdmin() || isProjectManager() || isViewer();
      
      // WRITE: Only Admins and Project Managers can create, update, or delete contractors.
      allow write: if isAdmin() || isProjectManager();
    }

    // /dailyReports collection Rules
    match /dailyReports/{reportId} {
      // READ: Any user with a valid role can read reports.
      allow get, list: if isAdmin() || isProjectManager() || isViewer();
      
      // WRITE: Only Admins and Project Managers can create, update, or delete reports.
      allow write: if isAdmin() || isProjectManager();
    }
    
    // /monthlyReports collection Rules
    match /monthlyReports/{reportId} {
       // READ: Any user with a valid role can read reports.
       allow get, list: if isAdmin() || isProjectManager() || isViewer();

       // WRITE: Only Admins and Project Managers can create, update, or delete reports.
       allow write: if isAdmin() || isProjectManager();
    }

    // /system collection Rules
    match /system/{docId} {
      // READ: Any authenticated user with a valid role can read system metadata.
      allow get: if isAdmin() || isProjectManager() || isViewer();
      
      // WRITE: No client can write to system metadata. This should only be handled by backend functions.
      allow write: if false;
    }
  }
}
